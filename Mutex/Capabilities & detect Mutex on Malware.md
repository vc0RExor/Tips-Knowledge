# _What is Mutex?

_When we are talking about Mutex objects, We talk about protect shared rsrc by threads, this rsrc is holded by a thread on a process, only THIS Mutex may be executed by the thread, no one thread can acess to this resource if don't have this Mutex. The abstract concept of resource, may be an access to a certainly code region or an access to a DDBB. As you can suppose, only one thread can execute and access to this Mutex and obviously to this resource. If other Thread needs to access to a region, the thread need to request the ownership._

The image will clear you with a graphic about the Mutex, this has the Shared rsrc and the Threads requests the access to this. It seems as complex mechanism, but you only need to know that:

> - Mutex has the access to a region
> - Threads, requests his access to this
> - Only 1 thread can use this Mutex

![Mutex_xplain](https://user-images.githubusercontent.com/91592110/136946038-f5aefc56-e2e9-4e0e-8e4f-f6f00b6e84a6.png)

# _Why Mutex is used on Malware?

As you can soppose with the last explanation, the Malware often uses Mutex objects to access to a region, but is not the most common use, Malware may use this objects to avoid the reinfection on a computer and avoid the detection, it's usually see malwares using a hardcoded string to represent a Mutex, and some Malware families have an structure to name the Mutex that are using, in other words, you can identify several Malware families if you detect a Mutex with specific name.

As you can see, the malware has two common way to use the Mutex, you not mistake with semaphores, this technique will be covered in future posts. You need to be clear that the Mutex objects in Malware are really good IOCs and If you can detect a Malware and classify it in a family it's a good catch.

# _How Malware uses Mutex?

I saw several techniques using the Mutex on Malwares, but the most common is to use four imports, CreateMutex/OpenMutex, WaitForSingleObject/WaitForMultipleObjects, ReleaseMutex.

Create and OpenMutex it's to create a new Mutex or Open an existing, maybe the Malware makes in a specific moment because may be a RaaS and in other section needs to open or manipulate other Mutex, WaitForSingleObject it's used because first, to use a Mutex needs to require the ownership of this, this import grants to do the ReleaseMutex to drops the ownership of the Thread, to retake later or simply to finish to use the Mutex, in other words, one creates a TimeOut on a thread to make the request of the Mutex and get the ownership.

An example is on this Maze Ransomware, that are using Mutex objects, and in these imports, we can see the use of somes of these:

![0](https://user-images.githubusercontent.com/91592110/136946315-07944108-4f95-4608-b87a-c6c117f7172a.png)

You shouldn't forget when you are debugging and see this imports, if you want to know what are doing with this Mutex, you can do a BreakPoint at this imports and see what is pushing on the stack before the call, for example, on the same Malware, you can see how OpenMutex is calling with 3 parameters (Always with the MSDN opened)

![2](https://user-images.githubusercontent.com/91592110/136946418-35976e71-1d26-454c-8dc9-2c3d7dd79a3d.png)

![6](https://user-images.githubusercontent.com/91592110/136946429-099d6c71-02ea-44bc-878f-9555dde37693.png)

As you can see, the most important is the name and the dwDesiredAccess, who determines the ***Object Security and Access Rights***.

# _How Detect Mutex?

Now you know more about the Mutex, we need to detect it, as you know, it's a good IOC and we can use to classify in this malware family. We have a lot of tools and techiques to detect or see the Mutex opened at this moment.

Normally I use the ProcExplorer to show all of mutants by PID, on this image you can see one malicious Mutex created by a Malware, when you are looking for Mutant and filtering by PID you get this:

![3](https://user-images.githubusercontent.com/91592110/136946677-087cc0ff-4141-4359-b5b1-20baddee7da7.png)

An other way to do the same is using other Sysinternal tool as _WinObj_, where you can see all of objects, to find Mutex you need to go to BaseNamedObjects

![4](https://user-images.githubusercontent.com/91592110/136946764-881cba4d-6448-4687-9a01-6465f7784ebb.png)

You can use others as:

> Opening a cmd o PowerShell
```
handle -a | findstr /C:Mutant /C:pid
```

> Using volatility and dump memory 
```
mutantscan -s
```

The First one is an archaic method, but is usefull, and the second it's if you are interested to find using forensics techiques, in the future I will cover some forensics tools and detections tricks on malware.

You can use whatever of this four tools, or others, the most important is to find the malicious Mutex, known how it works and what parameters uses to create or open it


> :t-rex: [vc0=Rexor](https://github.com/vc0RExor)  :detective:
